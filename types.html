<!DOCTYPE html><html><head><title>Types | NodObjC v0.0.12</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="assets/styles.css" rel="stylesheet"><link href="assets/ir_black.css" rel="stylesheet"><script src="assets/jquery-1.7.1.js" type="text/javascript"></script><script src="assets/script.js" type="text/javascript"></script></head><body><div id="content"><a href="index.html" id="title"><h1>NodObjC</h1><h3>The NodeJS &#8646; Objective-C Bridge</h3></a><div class="toc"><span class="page"><a href="block.html">block</a></span><span class="page"><a href="bridgesupport.html">bridgesupport</a></span><span class="page"><a href="class.html">class</a></span><span class="page"><a href="core.html">core</a></span><span class="page"><a href="exception.html">exception</a></span><span class="page"><a href="ffi-extend.html">ffi-extend</a></span><span class="page"><a href="global.html">global</a></span><span class="page"><a href="id.html">id</a></span><span class="page"><a href="imp.html">imp</a></span><span class="page"><a href="import.html">import</a></span><span class="page"><a href="index.html">index</a></span><span class="page"><a href="ivar.html">ivar</a></span><span class="page"><a href="method.html">method</a></span><span class="page"><a href="sel.html">sel</a></span><span class="page"><a href="struct.html">struct</a></span><span class="page"><a href="types.html">types</a></span></div><h2>Types</h2><div class="part"><div class="desc"><p>Logic for translating a given Objective-C &quot;type&quot; encoding into a node-ffi
type.

</p>
<h3>References:</h3>
<ul>
<li><a href="http://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Apple &quot;Type Encoding&quot; Docs</a></li>
<li><a href="https://github.com/rbranson/node-ffi/wiki/Node-FFI-Tutorial#wiki-type-list">node-ffi &quot;Type List&quot;</a></li>
</ul>
</div></div><div class="part"><div class="desc"><p>Module exports.</p>
</div><button class="show-code">Show Code</button><pre class="code"><code>exports.map = map
exports.mapArray = mapArray
exports.parse = parse</code></pre></div><div class="part"><div class="desc"><p>Module dependencies.</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="keyword">var</span> struct = require(<span class="string">'./struct'</span>)
  , assert = require(<span class="string">'assert'</span>)</code></pre></div><div class="part"><div class="desc"><div class="private"><div class="caution"></div>This is a private declaration used internally by <code>NodObjC</code>. You should <b>not</b> need to use this declaration in
your code.</div><p>A map of Objective-C type encodings to node-ffi types.
</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="keyword">var</span> typeEncodings = {
    <span class="string">'c'</span>: <span class="string">'char'</span>
  , <span class="string">'i'</span>: <span class="string">'int32'</span>
  , <span class="string">'s'</span>: <span class="string">'short'</span>
  , <span class="string">'l'</span>: <span class="string">'long'</span>
  , <span class="string">'q'</span>: <span class="string">'longlong'</span>
  , <span class="string">'C'</span>: <span class="string">'uchar'</span>
  , <span class="string">'I'</span>: <span class="string">'uint32'</span>
  , <span class="string">'S'</span>: <span class="string">'ushort'</span>
  , <span class="string">'L'</span>: <span class="string">'ulong'</span>
  , <span class="string">'Q'</span>: <span class="string">'ulonglong'</span>
  , <span class="string">'f'</span>: <span class="string">'float'</span>
  , <span class="string">'d'</span>: <span class="string">'double'</span>
  , <span class="string">'B'</span>: <span class="string">'int8'</span>
  , <span class="string">'v'</span>: <span class="string">'void'</span>
  , <span class="string">'*'</span>: <span class="string">'string'</span>   <span class="comment">// String</span>
  , <span class="string">'@'</span>: <span class="string">'pointer'</span>  <span class="comment">// id</span>
  , <span class="string">'#'</span>: <span class="string">'pointer'</span>  <span class="comment">// Class</span>
  , <span class="string">':'</span>: <span class="string">'pointer'</span>  <span class="comment">// SEL</span>
  , <span class="string">'?'</span>: <span class="string">'pointer'</span>  <span class="comment">// Unknown, used for function pointers</span>
}
exports.typeEncodings = typeEncodings
<span class="keyword">var</span> DELIMS = Object.keys(typeEncodings)</code></pre></div><div class="part"><div class="desc"><div class="private"><div class="caution"></div>This is a private declaration used internally by <code>NodObjC</code>. You should <b>not</b> need to use this declaration in
your code.</div><p>A map of the additional type info for some ObjC methods.
</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="keyword">var</span> methodEncodings = {
    <span class="string">'r'</span>: <span class="string">'const'</span>
  , <span class="string">'n'</span>: <span class="string">'in'</span>
  , <span class="string">'N'</span>: <span class="string">'inout'</span>
  , <span class="string">'o'</span>: <span class="string">'out'</span>
  , <span class="string">'O'</span>: <span class="string">'bycopy'</span>
  , <span class="string">'R'</span>: <span class="string">'byref'</span>
  , <span class="string">'V'</span>: <span class="string">'oneway'</span>
}
exports.methodEncodings = methodEncodings</code></pre></div><div class="part"><div class="desc"><p>Used to remove and method encodings present on the type.
NodObjC does not use them...</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="keyword">var</span> methodEncodingsTest = <span class="keyword">new</span> RegExp(<span class="string">'^('</span> + Object.keys(methodEncodings).join(<span class="string">'|'</span>) + <span class="string">')'</span>)</code></pre></div><div class="part"><h3>map()</h3><div class="desc"><p>Maps a single Obj-C &#39;type&#39; into a valid node-ffi type.
This mapping logic is kind of a mess...</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="function"><span class="keyword">function</span> <span class="title">map</span> <span class="params">(type)</span> {</span>
  <span class="keyword">if</span> (!type) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'got falsey "type" to map ('</span>+type+<span class="string">'). this should NOT happen!'</span>)
  <span class="keyword">if</span> (type.type) type = type.type
  <span class="keyword">if</span> (struct.isStruct(type)) <span class="keyword">return</span> struct.getStruct(type)
  type = type.replace(methodEncodingsTest, <span class="string">''</span>)
  <span class="comment">// if the first letter is a ^ then it's a "pointer" type</span>
  <span class="keyword">if</span> (type[<span class="number">0</span>] === <span class="string">'^'</span>) <span class="keyword">return</span> <span class="string">'pointer'</span>
  <span class="comment">// now we can try matching from the typeEncodings map</span>
  <span class="keyword">var</span> rtn = typeEncodings[type]
  <span class="keyword">if</span> (rtn) <span class="keyword">return</span> rtn
  <span class="comment">// last shot... try the last char? this may be a bad idea...</span>
  rtn = typeEncodings[type[type.length-<span class="number">1</span>]]
  <span class="keyword">if</span> (rtn) <span class="keyword">return</span> rtn
  <span class="comment">// couldn't find the type. throw a descriptive error as to why:</span>
  <span class="keyword">if</span> (type[<span class="number">0</span>] == <span class="string">'['</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Array types not yet supported: '</span> + type)
  <span class="keyword">if</span> (type[<span class="number">0</span>] == <span class="string">'('</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Union types not yet supported: '</span> + type)
  <span class="keyword">if</span> (type[<span class="number">0</span>] == <span class="string">'b'</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Bit field types not yet supported: '</span> + type)
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Could not convert type: '</span> + type)
}</code></pre></div><div class="part"><h3>mapArray()</h3><div class="desc"><p>Accepts an Array of ObjC return type and argument types (i.e. the result of
parse() below), and returns a new Array with the values mapped to valid ffi
types.</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="function"><span class="keyword">function</span> <span class="title">mapArray</span> <span class="params">(types)</span> {</span>
  <span class="keyword">return</span> types.map(<span class="function"><span class="keyword">function</span> <span class="params">(type)</span> {</span>
    <span class="keyword">return</span> Array.isArray(type) ? exports.mapArray(type) : exports.map(type)
  })
}</code></pre></div><div class="part"><h3>parse()</h3><div class="desc"><p>Parses a &quot;types string&quot; (i.e. <code>&#39;v@:&#39;</code>) and returns a &quot;types Array&quot;, where the
return type is the first array value, and an Array of argument types is the
array second value.</p>
</div><button class="show-code">Show Code</button><pre class="code"><code><span class="function"><span class="keyword">function</span> <span class="title">parse</span> <span class="params">(types)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> types === <span class="string">'string'</span>) {
    <span class="keyword">var</span> rtn = []
      , cur = []
      , len = types.length
      , depth = <span class="number">0</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;len; i++) {
      <span class="keyword">var</span> c = types[i]

      <span class="keyword">if</span> (depth || !<span class="regexp">/(\d)/</span>.test(c)) {
        cur.push(c)
      }

      <span class="keyword">if</span> (c == <span class="string">'{'</span> || c == <span class="string">'['</span> || c == <span class="string">'('</span>) {
        depth++
      } <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'}'</span> || c == <span class="string">']'</span> || c == <span class="string">')'</span>) {
        depth--
        <span class="keyword">if</span> (!depth)
          add()
      } <span class="keyword">else</span> <span class="keyword">if</span> (~DELIMS.indexOf(c) &amp;&amp; !depth) {
        add()
      }
    }
    <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">()</span> {</span>
      rtn.push(cur.join(<span class="string">''</span>))
      cur = []
      depth = <span class="number">0</span>
    }
    assert.equal(rtn[<span class="number">1</span>], <span class="string">'@'</span>, <span class="string">'_self argument expected as first arg: '</span> + types)
    assert.equal(rtn[<span class="number">2</span>], <span class="string">':'</span>, <span class="string">'SEL argument expected as second arg: '</span> + types)
    <span class="keyword">return</span> [ rtn[<span class="number">0</span>], rtn.slice(<span class="number">1</span>) ]
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> args = types.args
    assert.equal(args[<span class="number">0</span>], <span class="string">'@'</span>, <span class="string">'_self argument expected as first arg: '</span> + types)
    assert.equal(args[<span class="number">1</span>], <span class="string">':'</span>, <span class="string">'SEL argument expected as second arg: '</span> + types)
    <span class="keyword">return</span> [ types.retval, args ]
  }
}</code></pre></div></div><div id="footer">NodObjC &copy; 2011-2012 Nathan Rajlich. Documentation generated by <a href="https://github.com/visionmedia/dox">dox</a>.</div><a href="http://github.com/TooTallNate/NodObjC"><img id="ribbon" src="https://a248.e.akamai.net/camo.github.com/e6bef7a091f5f3138b8cd40bc3e114258dd68ddf/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub"></a></body></html>
