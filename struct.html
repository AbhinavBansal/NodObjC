<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>Struct | NodObjC v0.0.8</title><link href="assets/styles.css" rel="stylesheet"/><link href="assets/ir_black.css" rel="stylesheet"/><script src="assets/jquery-1.7.1.js" type="text/javascript"></script><script src="assets/script.js" type="text/javascript"></script></head><body><div id="content"><a href="http://github.com/TooTallNate/NodObjC" id="title"><h1>NodObjC</h1><h3>The NodeJS &#8646; Objective-C Bridge</h3></a><h2>Struct</h2><div class="part"><div class="desc"><p>Internal module that parses <em>struct type encodings</em> and turns them into<br />proper node-ffi <code>Struct</code> instances.</p>

<p>NodObjC uses these functions internally and you <strong>do not</strong> have to use the<br />functions from this module in your code.</p></div></div><div class="part"><div class="desc"><p>Module exports.</p></div><button class="show-code">Show Code</button><pre class="code"><code>exports<span class="preprocessor">.isStruct</span> = isStruct
exports<span class="preprocessor">.getStruct</span> = getStruct
exports<span class="preprocessor">.parseStructName</span> = parseStructName
exports<span class="preprocessor">.parseStruct</span> = parseStruct</code></pre></div><div class="part"><div class="desc"><p>Module dependencies.</p></div><button class="show-code">Show Code</button><pre class="code"><code><span class="identifier">var</span> <span class="constant">Struct</span> = <span class="identifier"><span class="keyword">require</span></span>(<span class="string">'./core'</span>).<span class="constant">Struct</span>
  , <span class="identifier">types</span> = <span class="identifier"><span class="keyword">require</span></span>(<span class="string">'./types'</span>)
  , <span class="identifier"><span class="keymethods">test</span></span> = <span class="regexp">/^\{.*?\}$/</span>
  , <span class="identifier">structs</span> = {}</code></pre></div><div class="part"><div class="desc"><p>Tests if the given arg is a <code>Struct</code> constructor or a string type encoding<br />describing a struct (then true), otherwise false.</p></div><button class="show-code">Show Code</button><pre class="code"><code><span class="function"><span class="keyword">function</span> <span class="title">isStruct</span> <span class="params">(type)</span></span> {
  <span class="keyword">return</span> !!<span class="built_in">type</span>.__isStructType__ || test.test(<span class="built_in">type</span>)
}</code></pre></div><div class="part"><div class="desc"><p>Returns the struct constructor function for the given struct name or type.</p>

<pre><code>{<span class="built_in">CGPoint</span>=<span class="string">"x"</span>d<span class="string">"y"</span>d}
</code></pre></div><button class="show-code">Show Code</button><pre class="code"><code>function getStruct (<span class="keyword">type</span>) {
  <span class="comment">// First check if a regular name was passed in</span>
  <span class="keyword">var</span> rtn = structs[<span class="keyword">type</span>];
  <span class="keyword">if</span> (rtn) <span class="keyword">return</span> rtn;
  <span class="comment">// If the struct type name has already been created, return that one</span>
  <span class="keyword">var</span> name = exports.parseStructName(<span class="keyword">type</span>)
  <span class="comment">//console.error('name: %s', name)</span>
  rtn = structs[name];
  <span class="keyword">if</span> (rtn) {
    <span class="comment">//console.error('returning cached Struct')</span>
    <span class="keyword">return</span> rtn;
  }
  <span class="comment">// Next parse the type structure</span>
  <span class="keyword">var</span> parsed = exports.parseStruct(<span class="keyword">type</span>);
  <span class="comment">// Otherwise we need to create a new Struct constructor</span>
  <span class="keyword">var</span> props = [];
  parsed.props.forEach(function (prop) {
    props.push([ types.<span class="keyword">map</span>(prop<span class="number">[1</span>]), prop<span class="number">[0</span>] ])
  })
  <span class="keyword">return</span> structs[parsed.name] = Struct(props)
}</code></pre></div><div class="part"><div class="desc"><p>Extracts only the name of the given struct type encoding string.</p></div><button class="show-code">Show Code</button><pre class="code"><code>function parseStructName (<span class="keyword">struct</span>) {
  <span class="keyword">var</span> s = <span class="keyword">struct</span>.substring<span class="number">(1</span>, <span class="keyword">struct</span>.length<span class="number">-1</span>)
    , equalIndex = s.indexOf(<span class="string">'='</span>)
  <span class="keyword">if</span> (~equalIndex)
    s = s.substring<span class="number">(0</span>, equalIndex)
  <span class="keyword">return</span> s
}</code></pre></div><div class="part"><div class="desc"><p>Parses a struct type string into an Object with a <code><span class="title">name</span></code> String and<br />a <code><span class="title">props</span></code> Array (entries are a type string, or another parsed struct object)</p></div><button class="show-code">Show Code</button><pre class="code"><code><span class="identifier">function</span> <span class="constant">parseStruct</span> (<span class="identifier">struct</span>) {
  <span class="identifier">var</span> <span class="identifier">s</span> = <span class="identifier">struct</span>.<span class="identifier">substring</span>(<span class="number">1</span>, <span class="identifier">struct</span>.<span class="identifier"><span class="keymethods">length</span></span>-<span class="number">1</span>)
    , <span class="constant">equalIndex</span> = <span class="identifier">s</span>.<span class="constant">indexOf</span>(<span class="string">'='</span>)
    , <span class="identifier">rtn</span> = {
        <span class="identifier"><span class="keymethods">name</span></span><span class="symbol">:</span> <span class="identifier">s</span>.<span class="identifier">substring</span>(<span class="number">0</span>, <span class="constant">equalIndex</span>)
      , <span class="identifier">props</span><span class="symbol">:</span> []
    }
  <span class="identifier">s</span> = <span class="identifier">s</span>.<span class="identifier">substring</span>(<span class="constant">equalIndex</span>+<span class="number">1</span>)
  <span class="identifier">var</span> <span class="constant">curProp</span> = []
    , <span class="constant">numBrackets</span> = <span class="number">0</span>
    , <span class="identifier"><span class="keymethods">entries</span></span> = []
  <span class="identifier"><span class="keyword">for</span></span> (<span class="identifier">var</span> <span class="identifier">i</span>=<span class="number">0</span>; <span class="identifier">i</span> &amp;<span class="identifier">lt</span>; <span class="identifier">s</span>.<span class="identifier"><span class="keymethods">length</span></span>; <span class="identifier">i</span>++) {
    <span class="identifier">var</span> <span class="identifier">cur</span> = <span class="identifier">s</span>[<span class="identifier">i</span>]
    <span class="identifier">switch</span> (<span class="identifier">cur</span>) {
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">'&quot;'</span><span class="symbol">:</span>
        <span class="identifier"><span class="keyword">if</span></span> (<span class="constant">numBrackets</span> &amp;<span class="identifier">gt</span>; <span class="number">0</span>)
          <span class="constant">curProp</span>.<span class="identifier"><span class="keymethods">push</span></span>(<span class="identifier">cur</span>)
        <span class="identifier"><span class="keyword">else</span></span>
          <span class="constant">addProp</span>()
        <span class="identifier"><span class="keyword">break</span></span>;
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">'{'</span><span class="symbol">:</span>
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">'['</span><span class="symbol">:</span>
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">'('</span><span class="symbol">:</span>
        <span class="constant">numBrackets</span>++
        <span class="constant">curProp</span>.<span class="identifier"><span class="keymethods">push</span></span>(<span class="identifier">cur</span>)
        <span class="identifier"><span class="keyword">break</span></span>;
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">'}'</span><span class="symbol">:</span>
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">']'</span><span class="symbol">:</span>
      <span class="identifier"><span class="keyword">case</span></span> <span class="string">')'</span><span class="symbol">:</span>
        <span class="constant">numBrackets</span>--
        <span class="constant">curProp</span>.<span class="identifier"><span class="keymethods">push</span></span>(<span class="identifier">cur</span>)
        <span class="identifier"><span class="keyword">break</span></span>;
      <span class="identifier"><span class="keymethods">default</span></span><span class="symbol">:</span>
        <span class="constant">curProp</span>.<span class="identifier"><span class="keymethods">push</span></span>(<span class="identifier">cur</span>)
        <span class="identifier"><span class="keyword">break</span></span>;
    }
  }
  <span class="constant">addProp</span>()
  <span class="identifier">function</span> <span class="constant">addProp</span> () {
    <span class="identifier"><span class="keymethods">entries</span></span>.<span class="identifier"><span class="keymethods">push</span></span>(<span class="constant">curProp</span>.<span class="identifier"><span class="keymethods">join</span></span>(<span class="string">''</span>))
    <span class="constant">curProp</span> = []
    <span class="constant">numBrackets</span> = <span class="number">0</span>
  }
  <span class="identifier"><span class="keyword">for</span></span> (<span class="identifier">var</span> <span class="identifier">i</span>=<span class="number">1</span>; <span class="identifier">i</span> &amp;<span class="identifier">lt</span>; <span class="identifier"><span class="keymethods">entries</span></span>.<span class="identifier"><span class="keymethods">length</span></span>; <span class="identifier">i</span>+=<span class="number">2</span>) {
    <span class="identifier">rtn</span>.<span class="identifier">props</span>.<span class="identifier"><span class="keymethods">push</span></span>([<span class="identifier"><span class="keymethods">entries</span></span>[<span class="identifier">i</span>], <span class="identifier"><span class="keymethods">entries</span></span>[<span class="identifier">i</span>+<span class="number">1</span>]])
  }
  <span class="identifier"><span class="keyword">return</span></span> <span class="identifier">rtn</span>
}</code></pre></div></div><div id="footer">NodObjC &copy; 2011-2012 Nathan Rajlich. Documentation generated by 
<a href="https://github.com/visionmedia/dox">dox</a>.
</div><a href="http://github.com/TooTallNate/NodObjC"><img id="ribbon" src="https://a248.e.akamai.net/assets.github.com/img/4c7dc970b89fd04b81c8e221ba88ff99a06c6b61/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub"/></a></body></html>