<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>Block | NodObjC v0.0.8</title><link href="assets/styles.css" rel="stylesheet"/><script src="assets/jquery-1.7.1.js" type="text/javascript"></script><script src="assets/script.js" type="text/javascript"></script></head><body><div id="content"><a href="http://github.com/TooTallNate/NodObjC" id="title"><h1>NodObjC</h1><h3>The NodeJS &#8646; Objective-C Bridge</h3></a><h2>Block</h2><div class="part"><div class="desc"><h4>NOTE: block support in NodObjC is currently experimental!</h4>

<p><strong>NodObjC</strong> implements support for <a href="http://en.wikipedia.org/wiki/Blocks_%28C_language_extension%29">C Blocks</a>!</p>

<h3>References:</h3>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Blocks_%28C_language_extension%29">Wikipedia "Blocks (C language extension)"</a></li>
<li><a href='http://clang.llvm.org/docs/Block-ABI-Apple.txt'>http://clang.llvm.org/docs/Block-ABI-Apple.txt</a></li>
</ul></div></div><div class="part"><div class="desc"><p>We have to simulate what the llvm compiler does when it encounters a Block<br />literal expression (see Block-ABI-Apple.txt above).<br />The "block literal" is the struct type for each Block instance.</p></div><button class="show-code">Show Code</button><pre class="code"><code>var __block_literal_1 = ffi.Struct([
    ['pointer', 'isa']
  , ['int32', 'flags']
  , ['int32', 'reserved']
  , ['pointer', 'invoke']
  , ['pointer', 'descriptor']
])</code></pre></div><div class="part"><div class="desc"><p>The "block descriptor" is a static singleton struct. Probably used in more<br />complex Block scenarios involving actual closure variables needing storage<br />(in NodObjC, JavaScript closures are leveraged instead).</p></div><button class="show-code">Show Code</button><pre class="code"><code>var __block_descriptor_1 = ffi.Struct([
    ['ulonglong', 'reserved']
  , ['ulonglong', 'Block_size']
])

var BD = new __block_descriptor_1()
BD.reserved = 0
BD.Block_size = ffi.sizeOf(__block_literal_1)


// The class of the block instances; lazy-loaded
var CGB</code></pre></div><div class="part"><h3>createBlockPointer()</h3><div class="desc"><p>Creates a C block instance from a JS function and returns it's pointer</p></div><button class="show-code">Show Code</button><pre class="code"><code>function createBlockPointer (func, type) {
  if (!func) return null
  var bl = new __block_literal_1
  // Set the class of the instance
  bl.isa = CGB || (CGB = core.dlopen().get('_NSConcreteGlobalBlock'))
  // Global flags
  bl.flags = 1 &lt;&lt; 29
  bl.reserved = 0
  bl.invoke = imp.createWrapperPointer(func, type)
  bl.descriptor = BD.ref()
  return bl.ref()
}</code></pre></div><div class="part"><h3>createBlock()</h3><div class="desc"><p>Creates a C block instance from a JS Function.<br />Blocks are regular Objective-C objects in Obj-C, and can be sent messages;<br />thus Block instances need are creted using the id.wrap() function.</p></div><button class="show-code">Show Code</button><pre class="code"><code>function createBlock (func, type) {
  return id.wrap(createBlockPointer(func, type))
}</code></pre></div><div class="part"><h3>getPointer()</h3><div class="desc"><p>Gets an ffi pointer to a C block from an existing wrapped Block instance, or<br />creates a new block with _createBlock(). The second case should be most common<br />since it will be rare to create your own Block intstances and pass them around.</p></div><button class="show-code">Show Code</button><pre class="code"><code>function getPointer (blockOrFunc, type) {
  if ('pointer' in blockOrFunc) {
    return blockOrFunc.pointer
  } else {
    return createBlockPointer(blockOrFunc, type)
  }
}</code></pre></div></div><div id="footer">NodObjC &copy; 2011-2012 Nathan Rajlich. Documentation generated by 
<a href="https://github.com/visionmedia/dox">dox</a>.
</div><a href="http://github.com/TooTallNate/NodObjC"><img id="ribbon" src="https://a248.e.akamai.net/assets.github.com/img/4c7dc970b89fd04b81c8e221ba88ff99a06c6b61/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub"/></a></body></html>